<%- include('partials/header') %>

<!-- Fő tartalom -->
<div id="main" class="wrapper style1">
    <div class="content-section">
        <div class="container">
            
            <!-- Header -->
            <div class="hero-section">
                <h1 class="hero-title">Diagramok a múltbeli nagydíjakról</h1>
            </div>
    
            <!-- Szűrők (Form) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card-f1">
                        <form method="GET" action="<%= baseUrl %>/diagrams">
                            <div class="row gtr-uniform">
                                <div class="col-4 col-12-small">
                                    <select name="team" style="background: rgba(0,0,0,0.3); border-color: #555; color: white; background-color: #333;">
                                        <option value="">Összes csapat</option>
                                        <% if(typeof teams !== 'undefined') { %>
                                            <% teams.forEach(t => { %>
                                                <option value="<%= t %>" <%= selectedTeam === t ? 'selected' : '' %>><%= t %></option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-4 col-12-small">
                                    <select name="year" style="background: rgba(0,0,0,0.3); border-color: #555; color: white; background-color: #333;">
                                        <option value="">Összes év</option>
                                        <% if(typeof years !== 'undefined') { %>
                                            <% years.forEach(y => { %>
                                                <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-4 col-12-small">
                                    <button class="button primary fit small">Szűrés</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Gombok -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="btn-group" role="group">
                        <button type="button" class="button primary" onclick="showChart('dnf')" id="dnfBtn">
                            DNF Bar Chart
                        </button>
                        <button type="button" class="button alt" onclick="showChart('bar')" id="barBtn">
                            Helyszín Gyakoriság
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-primary fs-6" style="padding: 10px;">
                        <% if(selectedTeam || selectedYear) { %>
                            Szűrve: 
                            <%= selectedTeam ? selectedTeam : '' %>
                            <%= selectedYear ? selectedYear : '' %>
                        <% } else { %>
                            Adatok: <%= dnfData.detailedData.length %> DNF rekord
                        <% } %>
                    </div>
                </div>
            </div>
    
            <!-- DNF Chart -->
            <div id="dnfChart" class="chart-container">
                <div class="card shadow-sm card-f1">
                    <div class="card-body">
                        <h2 class="text-center mb-4" style="color: #ff6b6b;">DNF Statisztikák</h2>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="dnfBarChart" style="max-height: 600px;"></canvas> <!-- Magasabb canvas, hogy kiférjen -->
                            </div>
                            <div class="col-md-4">
                                <h5 style="color: #fff;">
                                    <%= dnfData.isFiltered ? 'Szűrt Részletek' : 'Összesítés' %>
                                </h5>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <% if(dnfData.isFiltered) { %>
                                        <!-- Részletes lista szűréskor -->
                                        <table class="table table-f1">
                                            <thead>
                                                <tr><th>Csapat</th><th>Dátum</th><th>Hiba</th></tr>
                                            </thead>
                                            <tbody>
                                                <% dnfData.detailedData.forEach(function(dnf) { %>
                                                <tr>
                                                    <td><%= dnf.team %></td>
                                                    <td><small><%= new Date(dnf.race_date).toLocaleDateString('hu-HU') %></small></td>
                                                    <td><span class="badge" style="background: #e10600; color: white;"><%= dnf.issue || 'N/A' %></span></td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    <% } else { %>
                                        <!-- Összesített lista (Rendezve!) -->
                                        <table class="table table-f1">
                                            <thead>
                                                <tr><th>Csapat</th><th>DNF szám</th></tr>
                                            </thead>
                                            <tbody>
                                                <!-- Itt trükközünk: a controller rendezett listáját használjuk -->
                                                <% dnfData.labels.forEach((team, index) => { %>
                                                <tr>
                                                    <td><%= team %></td>
                                                    <td><span class="badge" style="background: #e10600; color: white;"><%= dnfData.values[index] %></span></td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Location Chart -->
            <div id="barChart" class="chart-container" style="display: none;">
                <div class="card shadow-sm card-f1">
                    <div class="card-body">
                        <h2 class="text-center mb-4" style="color: #ff6b6b;">Helyszínek statisztikája</h2>
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="locationBarChart" style="max-height: 600px;"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-f1">
                                        <thead>
                                            <tr><th>Helyszín</th><th>Versenyek</th></tr>
                                        </thead>
                                        <tbody>
                                            <% locationData.locations.forEach(function(loc, i) { %>
                                            <tr>
                                                <td><%= loc %></td>
                                                <td><span class="badge" style="background: #e10600; color: white;"><%= locationData.raceCounts[i] %></span></td>
                                            </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Stats Summary -->
            <div class="row g-4 mt-5 mb-5">
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= dnfData.teams.length %></div>
                        <h3>Csapatok</h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= dnfData.detailedData.length %></div>
                        <h3>Összes DNF</h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= locationData.locations.length %></div>
                        <h3>Helyszínek</h3>
                    </div>
                </div>
            </div>
    
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // ADATOK BEOLVASÁSA 
      
    // DNF
    const dnfLabels = <%- JSON.stringify(dnfData.labels) %>;
    const dnfValues = <%- JSON.stringify(dnfData.values) %>;
    
    // Helyszín
    const locLabels = <%- JSON.stringify(locationData.locations) %>;
    const locValues = <%- JSON.stringify(locationData.raceCounts) %>;
    
    let dnfChart, barChart;
    
    document.addEventListener('DOMContentLoaded', function() {
        initDnfChart();
        initBarChart();
    });
    
    function showChart(chartType) {
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.display = 'none';
        });
        
        const dnfBtn = document.getElementById('dnfBtn');
        const barBtn = document.getElementById('barBtn');

        if (chartType === 'dnf') {
            document.getElementById('dnfChart').style.display = 'block';
            dnfBtn.classList.remove('alt'); dnfBtn.classList.add('primary');
            barBtn.classList.remove('primary'); barBtn.classList.add('alt');
        } else if (chartType === 'bar') {
            document.getElementById('barChart').style.display = 'block';
            barBtn.classList.remove('alt'); barBtn.classList.add('primary');
            dnfBtn.classList.remove('primary'); dnfBtn.classList.add('alt');
        }
    }
    
    function initDnfChart() {
        const ctx = document.getElementById('dnfBarChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if (dnfChart) dnfChart.destroy();
        
        dnfChart = new Chart(context, {
            type: 'bar',
            data: {
                labels: dnfLabels,
                datasets: [{
                    label: 'DNF Szám',
                    data: dnfValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: 'white' } }
                },
                scales: { 
                    x: { beginAtZero: true, ticks: { color: 'white' } },
                    y: { ticks: { color: 'white' } }
                }
            }
        });
    }
    
    function initBarChart() {
        const ctx = document.getElementById('locationBarChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if (barChart) barChart.destroy();
        
        barChart = new Chart(context, {
            type: 'bar',
            data: {
                labels: locLabels,
                datasets: [{
                    label: 'Grand Prix Szám',
                    data: locValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: 'white' } }
                },
                scales: { 
                    x: { beginAtZero: true, ticks: { color: 'white' } },
                    y: { ticks: { color: 'white' } }
                }
            }
        });
    }
</script>

<%- include('partials/footer') %>