<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramok</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .hero-section {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, #15151e 0%, #2c3e50 100%);
            color: white;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
        }
        .hero-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        .card-f1 {
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 25px;
            height: 100%;
        }
        .chart-stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e10600;
        }
        .btn-f1 {
            background-color: #e10600;
            color: white;
            border: none;
        }
        .btn-f1:hover { background-color: #b30000; color: white; }
        .btn-outline-f1 {
            border: 2px solid #e10600;
            color: #e10600;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 5px;
            display: inline-block;
        }
        .btn-outline-f1:hover { background-color: #e10600; color: white; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">F1 Tech Statisztikák</a>
            <a href="/" class="btn btn-sm btn-outline-light">Vissza</a>
        </div>
    </nav>

    <div class="content-section">
        <div class="container">
            <!-- Header -->
            <div class="hero-section">
                <h1 class="hero-title">Diagramok a múltbeli nagydíjakról</h1>
            </div>
    
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Szűrők</h5>
                            <form method="GET" action="/diagrams">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="team" class="form-label">Csapat</label>
                                        <select name="team" id="team" class="form-select">
                                            <option value="">Összes csapat</option>
                                            <% teams.forEach(function(team) { %>
                                                <option value="<%= team %>" <%= selectedTeam == team ? 'selected' : '' %>><%= team %></option>
                                            <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="year" class="form-label">Év</label>
                                        <select name="year" id="year" class="form-select">
                                            <option value="">Összes év</option>
                                            <% years.forEach(function(year) { %>
                                                <option value="<%= year %>" <%= selectedYear == year ? 'selected' : '' %>><%= year %></option>
                                            <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary me-2">Szűrés</button>
                                        <a href="/diagrams" class="btn btn-outline-secondary">Törlés</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary" onclick="showChart('dnf')" id="dnfBtn">
                            DNF Bar Chart
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="showChart('bar')" id="barBtn">
                            Helyszín Gyakoriság
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-primary fs-6">
                        <% if(selectedTeam || selectedYear) { %>
                            Szűrve: 
                            <% if(selectedTeam) { %> <%= selectedTeam %> <% } %>
                            <% if(selectedYear) { %> <%= selectedYear %> <% } %>
                        <% } else { %>
                            Adatok: <%= dnfData.detailedData.length %> DNF rekord
                        <% } %>
                    </div>
                </div>
            </div>
    
            <div id="dnfChart" class="chart-container">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="text-center mb-4">DNF Statisztikák - Bar Chart</h2>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="dnfBarChart" style="max-height: 400px;"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h5>
                                    <%= dnfData.isFiltered ? 'Szűrt DNF Részletek' : 'DNF Összesítés' %>
                                </h5>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <% if(dnfData.isFiltered) { %>
                                        <!-- Szűrt nézet: részletes rekordok -->
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>Csapat</th>
                                                    <th>Dátum</th>
                                                    <th>Hiba</th>
                                                    <th>Motor</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if(dnfData.detailedData.length > 0) { %>
                                                    <% dnfData.detailedData.forEach(function(dnf) { %>
                                                    <tr>
                                                        <td class="fw-bold"><%= dnf.team %></td>
                                                        <td><small><%= new Date(dnf.race_date).toLocaleDateString('hu-HU') %></small></td>
                                                        <td><span class="badge bg-warning text-dark"><%= dnf.issue || 'N/A' %></span></td>
                                                        <td><small><%= dnf.engine || 'N/A' %></small></td>
                                                    </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr><td colspan="4" class="text-center text-muted">Nincs DNF adat</td></tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                    <% } else { %>
                                        <!-- Alapértelmezett nézet: összesítés -->
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>Csapat</th>
                                                    <th>DNF szám</th>
                                                    <th>Fő problémák</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% Object.entries(dnfData.teamDNFCounts).forEach(function([team, count]) { %>
                                                <tr>
                                                    <td class="fw-bold"><%= team %></td>
                                                    <td><span class="badge bg-danger"><%= count %></span></td>
                                                    <td>
                                                        <small>
                                                            <!-- JS-ben szűrjük ki az issue-kat -->
                                                            <%= [...new Set(dnfData.detailedData.filter(d => d.team === team).map(d => d.issue).filter(i => i))].join(', ') || 'N/A' %>
                                                        </small>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Bar Chart - Location Frequency -->
            <div id="barChart" class="chart-container" style="display: none;">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="text-center mb-4">Nagydíj helyszínek statisztikája</h2>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="locationBarChart" style="max-height: 400px;"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th>Ország/Helyszín</th>
                                                <th>Versenyek</th>
                                                <th>Nagydíj neve</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% locationData.details.forEach(function(detail) { %>
                                            <tr>
                                                <td class="fw-bold"><%= detail.location %></td>
                                                <td><span class="badge bg-primary"><%= detail.unique_races %></span></td>
                                                <td><small><%= detail.name %></small></td>
                                            </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Statistics Summary -->
            <div class="row g-4 mt-5 mb-5">
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= dnfData.teams.length %></div>
                        <h3>Csapatok</h3>
                        <p class="text-muted">DNF rekordokkal</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= dnfData.detailedData.length %></div>
                        <h3>Összes DNF</h3>
                        <p class="text-muted">Szűrt eredmények</p>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-f1 text-center">
                        <div class="chart-stat-number"><%= locationData.locations.length %></div>
                        <h3>Helyszínek</h3>
                        <p class="text-muted">Grand Prix lokációk</p>
                    </div>
                </div>
            </div>
    
            <!-- Back Button -->
            <div class="text-center mt-5 mb-5">
                <a href="/" class="btn btn-outline-f1">
                    ← Vissza a főoldalra
                </a>
            </div>
        </div>
    </div>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
  const dnfData = JSON.parse('<%- JSON.stringify(dnfData) %>');
const locationData = JSON.parse('<%- JSON.stringify(locationData) %>');
    
    let dnfChart, barChart;
    
    document.addEventListener('DOMContentLoaded', function() {
        initDnfChart();
        initBarChart();
    });
    
    function showChart(chartType) {
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.display = 'none';
        });
        
        document.querySelectorAll('[id$="Btn"]').forEach(btn => {
            btn.className = btn.className.replace('btn-primary', 'btn-outline-primary');
        });
        
        if (chartType === 'dnf') {
            document.getElementById('dnfChart').style.display = 'block';
            document.getElementById('dnfBtn').className = 
                document.getElementById('dnfBtn').className.replace('btn-outline-primary', 'btn-primary');
        } else if (chartType === 'bar') {
            document.getElementById('barChart').style.display = 'block';
            document.getElementById('barBtn').className = 
                document.getElementById('barBtn').className.replace('btn-outline-primary', 'btn-primary');
        }
    }
    
    function initDnfChart() {
        const ctx = document.getElementById('dnfBarChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if (dnfChart) dnfChart.destroy();
        
        const teams = dnfData.teams || [];
        const dnfCounts = teams.map(team => dnfData.teamDNFCounts[team] || 0);
        
        // Színek generálása
        const baseColors = ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)'];
        const backgroundColors = teams.map((_, i) => baseColors[i % baseColors.length]);
        
        dnfChart = new Chart(context, {
            type: 'bar',
            data: {
                labels: teams,
                datasets: [{
                    label: 'DNF Szám',
                    data: dnfCounts,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
    
    function initBarChart() {
        const ctx = document.getElementById('locationBarChart');
        if (!ctx) return;
        
        const context = ctx.getContext('2d');
        if (barChart) barChart.destroy();
        
        const locations = locationData.locations || [];
        const raceCounts = locationData.raceCounts || [];
        
        barChart = new Chart(context, {
            type: 'bar',
            data: {
                labels: locations,
                datasets: [{
                    label: 'Grand Prix Szám',
                    data: raceCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
    </script>
</body>
</html>